<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Личный кабинет - Armenian Flavors</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .profile-page {
            padding: 40px 0;
        }
        
        .profile-header {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 40px;
            border-radius: var(--radius);
            margin-bottom: 40px;
        }
        
        .profile-info {
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        
        .profile-avatar {
            width: 120px;
            height: 120px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: var(--primary-color);
        }
        
        .profile-stats {
            display: flex;
            gap: 40px;
            margin-top: 20px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            display: block;
            font-size: 24px;
            font-weight: 700;
        }
        
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .profile-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: var(--text-light);
            position: relative;
            transition: var(--transition);
        }
        
        .tab-btn.active {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .tab-btn.active:after {
            content: '';
            position: absolute;
            bottom: -12px;
            left: 0;
            width: 100%;
            height: 3px;
            background: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .profile-form {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }
        
        .recipes-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .favorites-list,
        .comments-list {
            background: white;
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .comment-item,
        .favorite-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .comment-item:last-child,
        .favorite-item:last-child {
            border-bottom: none;
        }
        
        .comment-info {
            flex: 1;
        }
        
        .comment-date {
            color: var(--text-light);
            font-size: 14px;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            background: none;
            border: none;
            color: var(--text-light);
            cursor: pointer;
            padding: 5px;
            transition: var(--transition);
        }
        
        .action-btn:hover {
            color: var(--primary-color);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }
        
        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: var(--border-color);
        }
        
        .breadcrumbs {
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        .breadcrumbs a {
            color: var(--primary-color);
            text-decoration: none;
        }
        
        .breadcrumbs span {
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <!-- Шапка -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="../index.html" class="logo">
                    <i class="fas fa-utensils"></i>
                    <span>Armenian Flavors</span>
                </a>
                
                <div class="nav-menu">
                    <a href="../index.html" class="nav-link">Главная</a>
                    <a href="catalog.html" class="nav-link">Каталог рецептов</a>
                    <a href="add-recipe.html" class="nav-link">Добавить рецепт</a>
                    <a href="about.html" class="nav-link">О нас</a>
                </div>
                
                <div class="nav-actions">
                    <button class="btn btn-primary" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Выйти</span>
                    </button>
                </div>
                
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </nav>
        </div>
    </header>

    <!-- Основное содержимое -->
    <main class="container profile-page">
        <!-- Хлебные крошки -->
        <nav class="breadcrumbs">
            <a href="../index.html">Главная</a> >
            <span>Личный кабинет</span>
        </nav>
        
        <!-- Заголовок профиля -->
        <div class="profile-header">
            <div class="profile-info">
                <div class="profile-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <h1 id="userName">Загрузка...</h1>
                    <p id="userEmail">...</p>
                    <p>Участник с <span id="userSince">...</span></p>
                </div>
            </div>
            
            <div class="profile-stats">
                <div class="stat-item">
                    <span class="stat-value" id="recipesCount">0</span>
                    <span class="stat-label">Рецептов</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="favoritesCount">0</span>
                    <span class="stat-label">В избранном</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="commentsCount">0</span>
                    <span class="stat-label">Комментариев</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="totalViews">0</span>
                    <span class="stat-label">Просмотров</span>
                </div>
            </div>
        </div>
        
        <!-- Вкладки -->
        <div class="profile-tabs">
            <button class="tab-btn active" data-tab="profile">Профиль</button>
            <button class="tab-btn" data-tab="my-recipes">Мои рецепты</button>
            <button class="tab-btn" data-tab="favorites">Избранное</button>
            <button class="tab-btn" data-tab="comments">Мои комментарии</button>
            <button class="tab-btn" data-tab="settings">Настройки</button>
        </div>
        
        <!-- Содержимое вкладок -->
        
        <!-- Вкладка Профиль -->
        <div id="profile-tab" class="tab-content active">
            <div class="profile-form">
                <h2>Личная информация</h2>
                <form id="profileForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">Имя</label>
                            <input type="text" id="firstName" name="firstName">
                        </div>
                        <div class="form-group">
                            <label for="lastName">Фамилия</label>
                            <input type="text" id="lastName" name="lastName">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="username">Имя пользователя</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="bio">О себе</label>
                        <textarea id="bio" name="bio" rows="3" placeholder="Расскажите о себе..."></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Сохранить изменения
                        </button>
                        <button type="button" class="btn btn-outline" id="changePasswordBtn">
                            <i class="fas fa-key"></i> Сменить пароль
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Вкладка Мои рецепты -->
        <div id="my-recipes-tab" class="tab-content">
            <div class="section-header">
                <h2>Мои рецепты</h2>
                <a href="add-recipe.html" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Добавить рецепт
                </a>
            </div>
            
            <div class="recipes-list" id="userRecipes">
                <!-- Рецепты пользователя будут загружены через JavaScript -->
            </div>
            
            <div class="empty-state hidden" id="noRecipes">
                <i class="fas fa-utensils"></i>
                <h3>У вас еще нет рецептов</h3>
                <p>Добавьте свой первый рецепт армянской кухни!</p>
                <a href="add-recipe.html" class="btn btn-primary">Добавить рецепт</a>
            </div>
        </div>
        
        <!-- Вкладка Избранное -->
        <div id="favorites-tab" class="tab-content">
            <h2>Избранные рецепты</h2>
            
            <div class="favorites-list" id="favoritesList">
                <!-- Избранные рецепты будут загружены через JavaScript -->
            </div>
            
            <div class="empty-state hidden" id="noFavorites">
                <i class="fas fa-heart"></i>
                <h3>В избранном пока ничего нет</h3>
                <p>Добавляйте понравившиеся рецепты, чтобы они всегда были под рукой</p>
                <a href="catalog.html" class="btn btn-primary">Перейти в каталог</a>
            </div>
        </div>
        
        <!-- Вкладка Мои комментарии -->
        <div id="comments-tab" class="tab-content">
            <h2>Мои комментарии</h2>
            
            <div class="comments-list" id="userComments">
                <!-- Комментарии пользователя будут загружены через JavaScript -->
            </div>
            
            <div class="empty-state hidden" id="noComments">
                <i class="fas fa-comment"></i>
                <h3>У вас еще нет комментариев</h3>
                <p>Оставляйте комментарии к рецептам, чтобы помочь другим кулинарам</p>
            </div>
        </div>
        
        <!-- Вкладка Настройки -->
        <div id="settings-tab" class="tab-content">
            <div class="profile-form">
                <h2>Настройки аккаунта</h2>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="emailNotifications">
                        Получать email-уведомления
                    </label>
                    <small class="form-text">Новые комментарии, ответы на ваши отзывы</small>
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="newsletter">
                        Подписаться на рассылку
                    </label>
                    <small class="form-text">Новые рецепты, сезонные подборки</small>
                </div>
                
                <div class="form-group">
                    <label>Внешний вид</label>
                    <select id="theme" class="form-control">
                        <option value="light">Светлая тема</option>
                        <option value="dark">Темная тема</option>
                        <option value="auto">Автоматически</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-primary" id="saveSettings">
                        <i class="fas fa-save"></i> Сохранить настройки
                    </button>
                    <button type="button" class="btn btn-outline" id="exportData">
                        <i class="fas fa-download"></i> Экспорт данных
                    </button>
                </div>
                
                <hr style="margin: 30px 0;">
                
                <h3>Опасная зона</h3>
                <div class="danger-zone">
                    <p>Удаление аккаунта - необратимое действие. Все ваши рецепты и данные будут удалены.</p>
                    <button type="button" class="btn btn-danger" id="deleteAccount">
                        <i class="fas fa-trash"></i> Удалить аккаунт
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Подвал -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Armenian Flavors</h3>
                    <p>Кулинарный портал армянской кухни</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-vk"></i></a>
                        <a href="#"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Разделы</h4>
                    <a href="../index.html">Главная</a>
                    <a href="catalog.html">Каталог рецептов</a>
                    <a href="add-recipe.html">Добавить рецепт</a>
                    <a href="about.html">О нас</a>
                </div>
                <div class="footer-section">
                    <h4>Помощь</h4>
                    <a href="#">FAQ</a>
                    <a href="#">Контакты</a>
                    <a href="#">Правила сайта</a>
                </div>
                <div class="footer-section">
                    <h4>Контакты</h4>
                    <p><i class="fas fa-envelope"></i> info@armenianflavors.com</p>
                    <p><i class="fas fa-phone"></i> +7 (XXX) XXX-XX-XX</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Armenian Flavors. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <!-- Модальное окно смены пароля -->
    <div class="modal hidden" id="passwordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Смена пароля</h3>
                <button class="modal-close" id="closePasswordModal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="passwordForm">
                    <div class="form-group">
                        <label for="currentPassword">Текущий пароль</label>
                        <input type="password" id="currentPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Новый пароль</label>
                        <input type="password" id="newPassword" required>
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Подтвердите пароль</label>
                        <input type="password" id="confirmPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Изменить пароль</button>
                </form>
            </div>
        </div>
    </div>

    <script src="../script.js"></script>
    <script src="../indexedDB.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // Инициализируем базу данных
            await window.db.init();
            
            // Проверка авторизации
            const user = window.db?.getCurrentUser?.();
            if (!user) {
                window.location.href = 'auth.html?redirect=profile.html';
                return;
            }
            
            // Загрузка данных пользователя
            await loadUserData(user);
            await loadUserRecipes(user.id);
            await loadUserFavorites(user.id);
            await loadUserComments(user.id);
            
            // Инициализация вкладок
            initTabs();
            
            // Инициализация формы профиля
            initProfileForm(user);
            
            // Кнопка выхода
            document.getElementById('logoutBtn').addEventListener('click', function() {
                window.db?.logout?.();
                window.location.href = '../index.html';
            });
            
            // Модальное окно смены пароля
            initPasswordModal();
            
            // Настройки
            initSettings();
            
            // Удаление аккаунта
            document.getElementById('deleteAccount').addEventListener('click', function() {
                if (confirm('Вы уверены, что хотите удалить аккаунт? Это действие нельзя отменить.')) {
                    // Здесь была бы логика удаления аккаунта из IndexedDB
                    alert('Функция удаления аккаунта в разработке');
                }
            });
        });
        
        async function loadUserData(user) {
            document.getElementById('userName').textContent = user.login || 'Пользователь';
            document.getElementById('userEmail').textContent = user.email;
            document.getElementById('userSince').textContent = user.createdAt || '2024';
            
            // Заполняем форму профиля
            document.getElementById('firstName').value = user.firstName || '';
            document.getElementById('lastName').value = user.lastName || '';
            document.getElementById('email').value = user.email;
            document.getElementById('username').value = user.login;
            document.getElementById('bio').value = user.bio || '';
            
            // Обновляем статистику
            await updateUserStats(user.id);
        }
        
        // Функция обновления статистики пользователя
        async function updateUserStats(userId) {
            try {
                const userRecipes = await window.db.getRecipesByUser(userId);
                const favorites = await window.db.getUserFavorites(userId);
                const comments = await window.db.getCommentsByUser(userId);
                
                // Подсчет просмотров
                const totalViews = userRecipes.reduce((sum, recipe) => sum + (recipe.views || 0), 0);
                
                // Обновляем статистику
                document.getElementById('recipesCount').textContent = userRecipes.length;
                document.getElementById('favoritesCount').textContent = favorites.length;
                document.getElementById('commentsCount').textContent = comments.length;
                document.getElementById('totalViews').textContent = totalViews;
            } catch (error) {
                console.error('Ошибка обновления статистики:', error);
            }
        }
        
        // Функция для получения названия категории
        async function getCategoryName(id) {
            try {
                const category = await window.db.getCategoryById(id);
                return category?.name || 'Неизвестно';
            } catch (error) {
                console.error('Ошибка получения категории:', error);
                return 'Неизвестно';
            }
        }
        
        async function loadUserRecipes(userId) {
            try {
                const userRecipes = await window.db.getRecipesByUser(userId);
                const container = document.getElementById('userRecipes');
                const emptyState = document.getElementById('noRecipes');
                
                if (userRecipes.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                container.innerHTML = await Promise.all(userRecipes.map(async recipe => {
                    const categoryName = await getCategoryName(recipe.categoryId);
                    
                    return `
                        <div class="recipe-card">
                            <div class="recipe-image">
                                <i class="fas fa-utensils fa-3x"></i>
                            </div>
                            <div class="recipe-content">
                                <div class="recipe-category">${categoryName}</div>
                                <h3 class="recipe-title">${recipe.title}</h3>
                                <div class="recipe-meta">
                                    <span><i class="fas fa-clock"></i> ${recipe.cookingTime} мин</span>
                                    <span><i class="fas fa-signal"></i> ${recipe.difficulty}</span>
                                    <span><i class="fas fa-eye"></i> ${recipe.views || 0}</span>
                                    <span><i class="fas fa-heart"></i> ${recipe.favorites || 0}</span>
                                </div>
                                <p class="recipe-description">${recipe.description}</p>
                                <div class="recipe-footer">
                                    <div class="recipe-rating">
                                        <i class="fas fa-star"></i>
                                        <span>${recipe.rating?.toFixed(1) || '4.5'}</span>
                                    </div>
                                    <div class="action-buttons">
                                        <a href="recipe.html?id=${recipe.id}" class="btn btn-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="action-btn edit-recipe" data-id="${recipe.id}" title="Редактировать">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="action-btn delete-recipe" data-id="${recipe.id}" title="Удалить">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                })).then(html => html.join(''));
                
                // Обработчики кнопок
                document.querySelectorAll('.edit-recipe').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const recipeId = this.dataset.id;
                        alert('Редактирование рецепта в разработке');
                    });
                });
                
                document.querySelectorAll('.delete-recipe').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const recipeId = this.dataset.id;
                        if (confirm('Вы уверены, что хотите удалить этот рецепт?')) {
                            try {
                                // Здесь была бы логика удаления рецепта из IndexedDB
                                alert('Удаление рецептов в разработке');
                            } catch (error) {
                                console.error('Ошибка удаления рецепта:', error);
                                alert('Ошибка удаления рецепта');
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('Ошибка загрузки рецептов пользователя:', error);
            }
        }
        
        async function loadUserFavorites(userId) {
            try {
                const favorites = await window.db.getUserFavorites(userId);
                const allRecipes = await window.db.getAllRecipes();
                const container = document.getElementById('favoritesList');
                const emptyState = document.getElementById('noFavorites');
                
                if (favorites.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                const favoriteRecipes = favorites.map(fav => {
                    const recipe = allRecipes.find(r => r.id == fav.recipeId);
                    return recipe ? { ...recipe, favoriteDate: fav.date } : null;
                }).filter(Boolean);
                
                container.innerHTML = await Promise.all(favoriteRecipes.map(async recipe => {
                    const categoryName = await getCategoryName(recipe.categoryId);
                    
                    return `
                        <div class="favorite-item">
                            <div>
                                <h4><a href="recipe.html?id=${recipe.id}">${recipe.title}</a></h4>
                                <p class="comment-date">Категория: ${categoryName} | Добавлено: ${recipe.favoriteDate || 'Недавно'}</p>
                            </div>
                            <div class="action-buttons">
                                <button class="action-btn remove-favorite" data-id="${recipe.id}" title="Удалить из избранного">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                })).then(html => html.join(''));
                
                // Обработчик удаления из избранного
                document.querySelectorAll('.remove-favorite').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const recipeId = this.dataset.id;
                        const user = window.db.getCurrentUser();
                        
                        try {
                            await window.db.removeFromFavorites(user.id, recipeId);
                            await loadUserFavorites(user.id);
                            await updateUserStats(user.id);
                        } catch (error) {
                            console.error('Ошибка удаления из избранного:', error);
                            alert('Ошибка удаления из избранного');
                        }
                    });
                });
                
            } catch (error) {
                console.error('Ошибка загрузки избранного:', error);
            }
        }
        
        async function loadUserComments(userId) {
            try {
                const userComments = await window.db.getCommentsByUser(userId);
                const allRecipes = await window.db.getAllRecipes();
                const container = document.getElementById('userComments');
                const emptyState = document.getElementById('noComments');
                
                if (userComments.length === 0) {
                    container.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                container.innerHTML = await Promise.all(userComments.map(async comment => {
                    const recipe = allRecipes.find(r => r.id == comment.recipeId);
                    const categoryName = recipe ? await getCategoryName(recipe.categoryId) : '';
                    
                    return `
                        <div class="comment-item">
                            <div class="comment-info">
                                <h4>Рецепт: <a href="recipe.html?id=${comment.recipeId}">
                                    ${recipe?.title || 'Неизвестный рецепт'}
                                </a></h4>
                                <p>${comment.text}</p>
                                <div class="comment-meta">
                                    <span class="comment-date">${comment.date}</span>
                                    <span class="comment-rating">Оценка: ${'★'.repeat(comment.rating)}${'☆'.repeat(5 - comment.rating)}</span>
                                    ${recipe ? `<span>Категория: ${categoryName}</span>` : ''}
                                </div>
                            </div>
                            <div class="action-buttons">
                                <button class="action-btn delete-comment" data-id="${comment.id}" title="Удалить">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                })).then(html => html.join(''));
                
                // Обработчики удаления комментариев
                document.querySelectorAll('.delete-comment').forEach(btn => {
                    btn.addEventListener('click', async function() {
                        const commentId = this.dataset.id;
                        if (confirm('Вы уверены, что хотите удалить этот комментарий?')) {
                            try {
                                await window.db.deleteComment(commentId);
                                const user = window.db.getCurrentUser();
                                await loadUserComments(user.id);
                                await updateUserStats(user.id);
                            } catch (error) {
                                console.error('Ошибка удаления комментария:', error);
                                alert('Ошибка удаления комментария');
                            }
                        }
                    });
                });
                
            } catch (error) {
                console.error('Ошибка загрузки комментариев:', error);
            }
        }
        
        function initTabs() {
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // Убираем активный класс у всех кнопок
                    tabBtns.forEach(b => b.classList.remove('active'));
                    // Добавляем активный класс текущей кнопке
                    this.classList.add('active');
                    
                    // Скрываем все вкладки
                    tabContents.forEach(content => content.classList.remove('active'));
                    
                    // Показываем нужную вкладку
                    const tabId = this.dataset.tab;
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
        }
        
        function initProfileForm(user) {
            document.getElementById('profileForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const firstName = document.getElementById('firstName').value;
                const lastName = document.getElementById('lastName').value;
                const email = document.getElementById('email').value;
                const username = document.getElementById('username').value;
                const bio = document.getElementById('bio').value;
                
                try {
                    // Обновляем данные пользователя
                    await window.db.updateUser(user.id, {
                        firstName,
                        lastName,
                        email,
                        login: username,
                        bio
                    });
                    
                    // Обновляем текущего пользователя
                    const updatedUser = await window.db.getUserById(user.id);
                    window.db.currentUser = updatedUser;
                    localStorage.setItem('currentUser', JSON.stringify(updatedUser));
                    
                    alert('Данные профиля сохранены');
                    
                    // Обновляем имя в заголовке
                    document.getElementById('userName').textContent = username;
                    document.getElementById('userEmail').textContent = email;
                    
                } catch (error) {
                    console.error('Ошибка сохранения профиля:', error);
                    alert('Ошибка сохранения данных');
                }
            });
        }
        
        function initPasswordModal() {
            const modal = document.getElementById('passwordModal');
            const openBtn = document.getElementById('changePasswordBtn');
            const closeBtn = document.getElementById('closePasswordModal');
            
            openBtn.addEventListener('click', function() {
                modal.classList.remove('hidden');
            });
            
            closeBtn.addEventListener('click', function() {
                modal.classList.add('hidden');
            });
            
            // Закрытие при клике вне модального окна
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                }
            });
            
            // Обработка формы смены пароля
            document.getElementById('passwordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                // Валидация
                if (newPassword !== confirmPassword) {
                    alert('Пароли не совпадают');
                    return;
                }
                
                if (newPassword.length < 6) {
                    alert('Пароль должен содержать минимум 6 символов');
                    return;
                }
                
                // Здесь была бы логика смены пароля в IndexedDB
                alert('Смена пароля в разработке');
                modal.classList.add('hidden');
                this.reset();
            });
        }
        
        function initSettings() {
            // Загрузка сохраненных настроек
            const savedSettings = JSON.parse(localStorage.getItem('userSettings')) || {};
            
            if (savedSettings.emailNotifications !== undefined) {
                document.getElementById('emailNotifications').checked = savedSettings.emailNotifications;
            }
            
            if (savedSettings.newsletter !== undefined) {
                document.getElementById('newsletter').checked = savedSettings.newsletter;
            }
            
            if (savedSettings.theme) {
                document.getElementById('theme').value = savedSettings.theme;
            }
            
            // Сохранение настроек
            document.getElementById('saveSettings').addEventListener('click', function() {
                const settings = {
                    emailNotifications: document.getElementById('emailNotifications').checked,
                    newsletter: document.getElementById('newsletter').checked,
                    theme: document.getElementById('theme').value
                };
                
                localStorage.setItem('userSettings', JSON.stringify(settings));
                alert('Настройки сохранены');
            });
            
            // Экспорт данных
            document.getElementById('exportData').addEventListener('click', async function() {
                try {
                    const user = window.db.getCurrentUser();
                    const userRecipes = await window.db.getRecipesByUser(user.id);
                    const userComments = await window.db.getCommentsByUser(user.id);
                    const userFavorites = await window.db.getUserFavorites(user.id);
                    
                    const data = {
                        user: user,
                        recipes: userRecipes,
                        comments: userComments,
                        favorites: userFavorites,
                        exportDate: new Date().toISOString()
                    };
                    
                    const dataStr = JSON.stringify(data, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    // Создаем ссылку для скачивания
                    const url = URL.createObjectURL(dataBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `armenian-flavors-data-${user.login}-${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                } catch (error) {
                    console.error('Ошибка экспорта данных:', error);
                    alert('Ошибка экспорта данных');
                }
            });
        }
    </script>
</body>
</html>