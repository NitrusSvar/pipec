<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Добавить рецепт - Armenian Flavors</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
    <style>
        .add-recipe-page {
            padding: 40px 0;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .page-header h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        
        .form-container {
            background: white;
            padding: 40px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .form-section {
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
        }
        
        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .form-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--radius);
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            transition: var(--transition);
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        .ingredients-container {
            margin-top: 20px;
        }
        
        .ingredient-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        @media (max-width: 768px) {
            .ingredient-row {
                grid-template-columns: 1fr;
            }
        }
        
        .add-ingredient-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .remove-ingredient-btn {
            background: #f44336;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .steps-container {
            margin-top: 20px;
        }
        
        .step-row {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: flex-start;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
        }
        
        .step-text {
            flex: 1;
        }
        
        .step-text textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
        }
        
        .step-actions {
            display: flex;
            gap: 5px;
        }
        
        .step-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
        }
        
        .add-step-btn {
            background: var(--primary-color);
            color: white;
        }
        
        .remove-step-btn {
            background: #f44336;
            color: white;
        }
        
        .move-up-btn {
            background: #2196F3;
            color: white;
        }
        
        .move-down-btn {
            background: #4CAF50;
            color: white;
        }
        
        .image-upload {
            border: 2px dashed var(--border-color);
            border-radius: var(--radius);
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
        }
        
        .image-upload:hover {
            border-color: var(--primary-color);
            background: rgba(211, 47, 47, 0.05);
        }
        
        .image-upload i {
            font-size: 48px;
            color: var(--text-light);
            margin-bottom: 15px;
        }
        
        .image-preview {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }
        
        .remove-image-btn {
            margin-top: 10px;
            background: #f44336;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: var(--radius);
            cursor: pointer;
        }
        
        .form-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        
        .btn-save {
            background: var(--primary-color);
            color: white;
            padding: 15px 40px;
            font-size: 18px;
        }
        
        .btn-preview {
            background: #2196F3;
            color: white;
        }
        
        .tips-container {
            background: #f9f9f9;
            padding: 20px;
            border-radius: var(--radius);
            margin-top: 30px;
        }
        
        .tips-container h3 {
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .tips-list {
            list-style: none;
            padding: 0;
        }
        
        .tips-list li {
            margin-bottom: 10px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .tips-list i {
            color: var(--primary-color);
            margin-top: 3px;
        }
        
        .character-counter {
            text-align: right;
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }
        
        .character-counter.warning {
            color: #ff9800;
        }
        
        .character-counter.error {
            color: #f44336;
        }
        
        .required {
            color: #f44336;
        }
        
        .form-note {
            font-size: 14px;
            color: var(--text-light);
            margin-top: 5px;
        }
        
        .difficulty-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .difficulty-btn {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border-color);
            background: white;
            border-radius: var(--radius);
            cursor: pointer;
            text-align: center;
            transition: var(--transition);
            min-width: 120px;
        }
        
        .difficulty-btn:hover {
            border-color: var(--primary-color);
        }
        
        .difficulty-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .category-checkboxes {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 10px;
        }
        
        .category-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .category-checkbox input {
            width: auto;
        }
        
        .time-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-input input {
            width: 100px;
            text-align: center;
        }
        
        .serving-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .serving-input input {
            width: 100px;
            text-align: center;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--radius);
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .preview-content {
            line-height: 1.6;
        }
        
        .preview-title {
            color: var(--primary-color);
            margin-bottom: 20px;
        }
        
        .preview-section {
            margin-bottom: 25px;
        }
        
        .preview-section h3 {
            color: var(--text-color);
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .preview-ingredients ul,
        .preview-steps ol {
            padding-left: 20px;
            margin: 0;
        }
        
        .preview-ingredients li,
        .preview-steps li {
            margin-bottom: 8px;
        }
        
        @media (max-width: 480px) {
            .form-container {
                padding: 20px;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .btn-save,
            .btn-preview {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Шапка -->
    <header class="header">
        <div class="container">
            <nav class="navbar">
                <a href="../index.html" class="logo">
                    <i class="fas fa-utensils"></i>
                    <span>Armenian Flavors</span>
                </a>
                
                <div class="nav-menu">
                    <a href="../index.html" class="nav-link">Главная</a>
                    <a href="catalog.html" class="nav-link">Каталог рецептов</a>
                    <a href="add-recipe.html" class="nav-link active">Добавить рецепт</a>
                    <a href="about.html" class="nav-link">О нас</a>
                </div>
                
                <div class="nav-actions">
                   
                    <a href="auth.html" class="btn btn-outline" id="authBtn">
                        <i class="fas fa-user"></i>
                        <span>Войти</span>
                    </a>
                    <a href="profile.html" class="btn btn-primary hidden" id="profileBtn">
                        <i class="fas fa-user-circle"></i>
                        <span>Профиль</span>
                    </a>
                </div>
                
                <button class="menu-toggle" id="menuToggle">
                    <i class="fas fa-bars"></i>
                </button>
            </nav>
        </div>
    </header>

    <!-- Основное содержимое -->
    <main class="container add-recipe-page">
        <!-- Заголовок страницы -->
        <div class="page-header">
            <h1>Добавить новый рецепт</h1>
            <p>Поделитесь своим любимым рецептом армянской кухни</p>
        </div>
        
        <!-- Форма добавления рецепта -->
        <div class="form-container">
            <form id="recipeForm">
                
                <!-- Основная информация -->
                <div class="form-section">
                    <h2><i class="fas fa-info-circle"></i> Основная информация</h2>
                    
                    <div class="form-group">
                        <label for="recipeTitle">Название рецепта <span class="required">*</span></label>
                        <input type="text" id="recipeTitle" name="title" placeholder="Например: Долма с виноградными листьями" required>
                        <div class="character-counter" id="titleCounter">0/100</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="recipeDescription">Описание рецепта <span class="required">*</span></label>
                        <textarea id="recipeDescription" name="description" rows="4" placeholder="Кратко опишите блюдо, его историю и особенности..." required></textarea>
                        <div class="character-counter" id="descriptionCounter">0/500</div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Категория <span class="required">*</span></label>
                            <div class="category-checkboxes">
                                <label class="category-checkbox">
                                    <input type="checkbox" name="category" value="1"> Супы
                                </label>
                                <label class="category-checkbox">
                                    <input type="checkbox" name="category" value="2"> Основные блюда
                                </label>
                                <label class="category-checkbox">
                                    <input type="checkbox" name="category" value="3"> Выпечка
                                </label>
                                <label class="category-checkbox">
                                    <input type="checkbox" name="category" value="4"> Закуски
                                </label>
                                <label class="category-checkbox">
                                    <input type="checkbox" name="category" value="5"> Десерты
                                </label>
                                <label class="category-checkbox">
                                    <input type="checkbox" name="category" value="6"> Напитки
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Сложность приготовления <span class="required">*</span></label>
                            <div class="difficulty-buttons">
                                <button type="button" class="difficulty-btn" data-difficulty="Легкая">Легкая</button>
                                <button type="button" class="difficulty-btn" data-difficulty="Средняя">Средняя</button>
                                <button type="button" class="difficulty-btn" data-difficulty="Сложная">Сложная</button>
                            </div>
                            <input type="hidden" id="difficulty" name="difficulty" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="cookingTime">Время приготовления <span class="required">*</span></label>
                            <div class="time-input">
                                <input type="number" id="cookingTime" name="cookingTime" min="5" max="480" placeholder="45" required>
                                <span>минут</span>
                            </div>
                            <div class="form-note">От 5 до 480 минут</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="servings">Количество порций</label>
                            <div class="serving-input">
                                <input type="number" id="servings" name="servings" min="1" max="20" placeholder="4">
                                <span>порций</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Ингредиенты -->
                <div class="form-section">
                    <h2><i class="fas fa-carrot"></i> Ингредиенты <span class="required">*</span></h2>
                    <p class="form-note">Укажите все необходимые ингредиенты для приготовления блюда</p>
                    
                    <div class="ingredients-container" id="ingredientsContainer">
                        <!-- Ингредиенты будут добавляться динамически -->
                        <div class="ingredient-row">
                            <input type="text" class="ingredient-name" placeholder="Например: Говяжий фарш" required>
                            <input type="text" class="ingredient-amount" placeholder="500">
                            <select class="ingredient-unit">
                                <option value="г">г</option>
                                <option value="кг">кг</option>
                                <option value="мл">мл</option>
                                <option value="л">л</option>
                                <option value="шт">шт</option>
                                <option value="ч.л.">ч.л.</option>
                                <option value="ст.л.">ст.л.</option>
                                <option value="стакан">стакан</option>
                                <option value="по вкусу">по вкусу</option>
                            </select>
                            <button type="button" class="remove-ingredient-btn" onclick="removeIngredient(this)">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="button" class="add-ingredient-btn" onclick="addIngredient()">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                
                <!-- Шаги приготовления -->
                <div class="form-section">
                    <h2><i class="fas fa-list-ol"></i> Шаги приготовления <span class="required">*</span></h2>
                    <p class="form-note">Подробно опишите каждый шаг приготовления блюда</p>
                    
                    <div class="steps-container" id="stepsContainer">
                        <!-- Шаги будут добавляться динамически -->
                        <div class="step-row">
                            <div class="step-number">1</div>
                            <div class="step-text">
                                <textarea class="step-description" placeholder="Опишите первый шаг приготовления..." required></textarea>
                            </div>
                            <div class="step-actions">
                                <button type="button" class="step-btn move-up-btn" onclick="moveStepUp(this)" disabled>
                                    <i class="fas fa-arrow-up"></i>
                                </button>
                                <button type="button" class="step-btn move-down-btn" onclick="moveStepDown(this)">
                                    <i class="fas fa-arrow-down"></i>
                                </button>
                                <button type="button" class="step-btn remove-step-btn" onclick="removeStep(this)">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button type="button" class="add-step-btn" onclick="addStep()">
                        <i class="fas fa-plus"></i> Добавить шаг
                    </button>
                </div>
                
                <!-- Изображения -->
                <div class="form-section">
                    <h2><i class="fas fa-images"></i> Изображения</h2>
                    <p class="form-note">Загрузите фотографии готового блюда (необязательно)</p>
                    
                    <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <h3>Перетащите сюда изображения или нажмите для выбора</h3>
                        <p>Поддерживаемые форматы: JPG, PNG, GIF. Максимальный размер: 5MB</p>
                    </div>
                    
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                    
                    <div class="image-preview" id="imagePreview">
                        <img src="" alt="Предпросмотр" class="preview-image" id="previewImage">
                        <button type="button" class="remove-image-btn" onclick="removeImage()">
                            <i class="fas fa-trash"></i> Удалить изображение
                        </button>
                    </div>
                </div>
                
                <!-- Дополнительная информация -->
                <div class="form-section">
                    <h2><i class="fas fa-ellipsis-h"></i> Дополнительно</h2>
                    
                    <div class="form-group">
                        <label for="recipeTips">Советы и рекомендации</label>
                        <textarea id="recipeTips" name="tips" rows="3" placeholder="Полезные советы, варианты замены ингредиентов и т.д."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="recipeHistory">История рецепта</label>
                        <textarea id="recipeHistory" name="history" rows="3" placeholder="Расскажите историю этого рецепта, если она у вас есть"></textarea>
                    </div>
                </div>
                
                <!-- Кнопки действий -->
                <div class="form-actions">
                    <button type="button" class="btn btn-preview" onclick="showPreview()">
                        <i class="fas fa-eye"></i> Предпросмотр
                    </button>
                    <button type="submit" class="btn btn-save">
                        <i class="fas fa-save"></i> Опубликовать рецепт
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Подсказки -->
        <div class="tips-container">
            <h3>Полезные советы для создания хорошего рецепта:</h3>
            <ul class="tips-list">
                <li><i class="fas fa-lightbulb"></i> Указывайте точное количество ингредиентов</li>
                <li><i class="fas fa-lightbulb"></i> Опишите каждый шаг максимально подробно</li>
                <li><i class="fas fa-lightbulb"></i> Добавляйте полезные советы и рекомендации</li>
                <li><i class="fas fa-lightbulb"></i> Укажите правильную сложность приготовления</li>
                <li><i class="fas fa-lightbulb"></i> Фотографии делают рецепт более привлекательным</li>
            </ul>
        </div>
    </main>

    <!-- Модальное окно предпросмотра -->
    <div class="modal" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Предпросмотр рецепта</h2>
                <button class="modal-close" onclick="closePreview()">&times;</button>
            </div>
            <div class="preview-content" id="previewContent">
                <!-- Контент предпросмотра будет загружен через JavaScript -->
            </div>
            <div style="text-align: center; margin-top: 20px;">
                <button type="button" class="btn btn-primary" onclick="closePreview()">
                    <i class="fas fa-edit"></i> Продолжить редактирование
                </button>
            </div>
        </div>
    </div>

    <!-- Подвал -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>Armenian Flavors</h3>
                    <p>Кулинарный портал армянской кухни</p>
                    <div class="social-links">
                        <a href="#"><i class="fab fa-facebook"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                        <a href="#"><i class="fab fa-vk"></i></a>
                        <a href="#"><i class="fab fa-telegram"></i></a>
                    </div>
                </div>
                <div class="footer-section">
                    <h4>Разделы</h4>
                    <a href="../index.html">Главная</a>
                    <a href="catalog.html">Каталог рецептов</a>
                    <a href="add-recipe.html">Добавить рецепт</a>
                    <a href="about.html">О нас</a>
                </div>
                <div class="footer-section">
                    <h4>Помощь</h4>
                    <a href="#">FAQ</a>
                    <a href="#">Контакты</a>
                    <a href="#">Правила сайта</a>
                </div>
                <div class="footer-section">
                    <h4>Контакты</h4>
                    <p><i class="fas fa-envelope"></i> info@armenianflavors.com</p>
                    <p><i class="fas fa-phone"></i> +7 (XXX) XXX-XX-XX</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 Armenian Flavors. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <script src="../script.js"></script>
    <script src="../db.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Проверка авторизации
            checkAuth();
            
            // Инициализация формы
            initForm();
            
            // Инициализация счетчиков символов
            initCharacterCounters();
            
            // Инициализация кнопок сложности
            initDifficultyButtons();
            
            // Обработка отправки формы
            document.getElementById('recipeForm').addEventListener('submit', handleSubmit);
        });
        
        // Функция проверки авторизации
        function checkAuth() {
            const user = window.db?.getCurrentUser?.();
            if (!user) {
                // Перенаправляем на страницу авторизации
                window.location.href = 'auth.html?redirect=add-recipe.html';
                return;
            }
            
            // Обновляем кнопки входа/профиля
            const authBtn = document.getElementById('authBtn');
            const profileBtn = document.getElementById('profileBtn');
            
            if (user) {
                authBtn?.classList.add('hidden');
                profileBtn?.classList.remove('hidden');
                profileBtn.querySelector('span').textContent = user.login;
            }
        }
        
        // Функция инициализации формы
        function initForm() {
            // Добавляем начальные ингредиенты и шаги
            addIngredient();
            addStep();
        }
        
        // Функция инициализации счетчиков символов
        function initCharacterCounters() {
            const titleInput = document.getElementById('recipeTitle');
            const descriptionInput = document.getElementById('recipeDescription');
            const titleCounter = document.getElementById('titleCounter');
            const descriptionCounter = document.getElementById('descriptionCounter');
            
            titleInput.addEventListener('input', function() {
                updateCounter(titleCounter, this.value.length, 100);
            });
            
            descriptionInput.addEventListener('input', function() {
                updateCounter(descriptionCounter, this.value.length, 500);
            });
            
            // Инициализируем начальные значения
            updateCounter(titleCounter, titleInput.value.length, 100);
            updateCounter(descriptionCounter, descriptionInput.value.length, 500);
        }
        
        // Функция обновления счетчика
        function updateCounter(counterElement, length, maxLength) {
            counterElement.textContent = `${length}/${maxLength}`;
            counterElement.className = 'character-counter';
            
            if (length > maxLength * 0.9) {
                counterElement.classList.add('error');
            } else if (length > maxLength * 0.75) {
                counterElement.classList.add('warning');
            }
        }
        
        // Функция инициализации кнопок сложности
        function initDifficultyButtons() {
            const buttons = document.querySelectorAll('.difficulty-btn');
            const hiddenInput = document.getElementById('difficulty');
            
            buttons.forEach(button => {
                button.addEventListener('click', function() {
                    // Убираем активный класс у всех кнопок
                    buttons.forEach(btn => btn.classList.remove('active'));
                    
                    // Добавляем активный класс текущей кнопке
                    this.classList.add('active');
                    
                    // Устанавливаем значение скрытого поля
                    hiddenInput.value = this.dataset.difficulty;
                });
            });
            
            // Устанавливаем значение по умолчанию
            buttons[1].click(); // Средняя сложность
        }
        
        // Функция добавления ингредиента
        let ingredientCount = 1;
        
        function addIngredient() {
            const container = document.getElementById('ingredientsContainer');
            ingredientCount++;
            
            const ingredientRow = document.createElement('div');
            ingredientRow.className = 'ingredient-row';
            ingredientRow.innerHTML = `
                <input type="text" class="ingredient-name" placeholder="Например: Говяжий фарш" required>
                <input type="text" class="ingredient-amount" placeholder="500">
                <select class="ingredient-unit">
                    <option value="г">г</option>
                    <option value="кг">кг</option>
                    <option value="мл">мл</option>
                    <option value="л">л</option>
                    <option value="шт">шт</option>
                    <option value="ч.л.">ч.л.</option>
                    <option value="ст.л.">ст.л.</option>
                    <option value="стакан">стакан</option>
                    <option value="по вкусу">по вкусу</option>
                </select>
                <button type="button" class="remove-ingredient-btn" onclick="removeIngredient(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(ingredientRow);
        }
        
        // Функция удаления ингредиента
        function removeIngredient(button) {
            const row = button.closest('.ingredient-row');
            if (row && document.querySelectorAll('.ingredient-row').length > 1) {
                row.remove();
            } else {
                alert('Должен быть хотя бы один ингредиент');
            }
        }
        
        // Функция добавления шага
        let stepCount = 1;
        
        function addStep() {
            const container = document.getElementById('stepsContainer');
            stepCount++;
            
            const stepRow = document.createElement('div');
            stepRow.className = 'step-row';
            stepRow.innerHTML = `
                <div class="step-number">${stepCount}</div>
                <div class="step-text">
                    <textarea class="step-description" placeholder="Опишите шаг приготовления..." required></textarea>
                </div>
                <div class="step-actions">
                    <button type="button" class="step-btn move-up-btn" onclick="moveStepUp(this)">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button type="button" class="step-btn move-down-btn" onclick="moveStepDown(this)">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button type="button" class="step-btn remove-step-btn" onclick="removeStep(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(stepRow);
            updateStepNumbers();
            updateStepButtons();
        }
        
        // Функция удаления шага
        function removeStep(button) {
            const container = document.getElementById('stepsContainer');
            const rows = container.querySelectorAll('.step-row');
            
            if (rows.length > 1) {
                button.closest('.step-row').remove();
                stepCount--;
                updateStepNumbers();
                updateStepButtons();
            } else {
                alert('Должен быть хотя бы один шаг приготовления');
            }
        }
        
        // Функция перемещения шага вверх
        function moveStepUp(button) {
            const row = button.closest('.step-row');
            const prevRow = row.previousElementSibling;
            
            if (prevRow) {
                row.parentNode.insertBefore(row, prevRow);
                updateStepNumbers();
                updateStepButtons();
            }
        }
        
        // Функция перемещения шага вниз
        function moveStepDown(button) {
            const row = button.closest('.step-row');
            const nextRow = row.nextElementSibling;
            
            if (nextRow) {
                row.parentNode.insertBefore(nextRow, row);
                updateStepNumbers();
                updateStepButtons();
            }
        }
        
        // Функция обновления нумерации шагов
        function updateStepNumbers() {
            const steps = document.querySelectorAll('.step-row');
            steps.forEach((step, index) => {
                step.querySelector('.step-number').textContent = index + 1;
            });
            stepCount = steps.length;
        }
        
        // Функция обновления состояния кнопок шагов
        function updateStepButtons() {
            const steps = document.querySelectorAll('.step-row');
            
            steps.forEach((step, index) => {
                const upBtn = step.querySelector('.move-up-btn');
                const downBtn = step.querySelector('.move-down-btn');
                
                upBtn.disabled = index === 0;
                downBtn.disabled = index === steps.length - 1;
            });
        }
        
        // Функция обработки загрузки изображения
        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Проверка типа файла
            if (!file.type.match('image.*')) {
                alert('Пожалуйста, выберите изображение');
                return;
            }
            
            // Проверка размера файла (5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Размер файла не должен превышать 5MB');
                return;
            }
            
            // Создание предпросмотра
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('imagePreview');
                const previewImage = document.getElementById('previewImage');
                
                previewImage.src = e.target.result;
                preview.style.display = 'block';
            };
            
            reader.readAsDataURL(file);
        }
        
        // Функция удаления изображения
        function removeImage() {
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('previewImage').src = '';
            document.getElementById('imageInput').value = '';
        }
        
        // Функция показа предпросмотра
        function showPreview() {
            if (!validateForm(true)) {
                return;
            }
            
            const formData = getFormData();
            const previewContent = document.getElementById('previewContent');
            
            let categoriesText = '';
            if (formData.categories.length > 0) {
                categoriesText = formData.categories.map(cat => {
                    const categoryNames = {
                        '1': 'Супы',
                        '2': 'Основные блюда',
                        '3': 'Выпечка',
                        '4': 'Закуски',
                        '5': 'Десерты',
                        '6': 'Напитки'
                    };
                    return categoryNames[cat] || cat;
                }).join(', ');
            }
            
            previewContent.innerHTML = `
                <h2 class="preview-title">${formData.title}</h2>
                
                <div class="preview-section">
                    <h3>Описание</h3>
                    <p>${formData.description}</p>
                </div>
                
                <div class="preview-section">
                    <h3>Информация</h3>
                    <p><strong>Категория:</strong> ${categoriesText}</p>
                    <p><strong>Сложность:</strong> ${formData.difficulty}</p>
                    <p><strong>Время приготовления:</strong> ${formData.cookingTime} минут</p>
                    <p><strong>Порций:</strong> ${formData.servings}</p>
                </div>
                
                <div class="preview-section preview-ingredients">
                    <h3>Ингредиенты</h3>
                    <ul>
                        ${formData.ingredients.map(ing => 
                            `<li>${ing.name} - ${ing.amount} ${ing.unit}</li>`
                        ).join('')}
                    </ul>
                </div>
                
                <div class="preview-section preview-steps">
                    <h3>Шаги приготовления</h3>
                    <ol>
                        ${formData.steps.map((step, index) => 
                            `<li>${step}</li>`
                        ).join('')}
                    </ol>
                </div>
                
                ${formData.tips ? `
                <div class="preview-section">
                    <h3>Советы и рекомендации</h3>
                    <p>${formData.tips}</p>
                </div>
                ` : ''}
                
                ${formData.history ? `
                <div class="preview-section">
                    <h3>История рецепта</h3>
                    <p>${formData.history}</p>
                </div>
                ` : ''}
            `;
            
            document.getElementById('previewModal').classList.add('active');
        }
        
        // Функция закрытия предпросмотра
        function closePreview() {
            document.getElementById('previewModal').classList.remove('active');
        }
        
        // Функция валидации формы
        function validateForm(isPreview = false) {
            const form = document.getElementById('recipeForm');
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            let errorMessage = '';
            
            // Проверка обязательных полей
            for (let field of requiredFields) {
                if (!field.value.trim()) {
                    isValid = false;
                    errorMessage += `Заполните поле: ${field.previousElementSibling?.textContent || 'Обязательное поле'}\n`;
                    field.style.borderColor = '#f44336';
                } else {
                    field.style.borderColor = '';
                }
            }
            
            // Проверка категорий
            const categories = form.querySelectorAll('input[name="category"]:checked');
            if (categories.length === 0) {
                isValid = false;
                errorMessage += 'Выберите хотя бы одну категорию\n';
            }
            
            // Проверка сложности
            const difficulty = document.getElementById('difficulty').value;
            if (!difficulty) {
                isValid = false;
                errorMessage += 'Выберите сложность приготовления\n';
            }
            
            // Проверка ингредиентов
            const ingredients = document.querySelectorAll('.ingredient-name');
            let hasEmptyIngredients = false;
            ingredients.forEach(ing => {
                if (!ing.value.trim()) {
                    hasEmptyIngredients = true;
                    ing.style.borderColor = '#f44336';
                } else {
                    ing.style.borderColor = '';
                }
            });
            
            if (hasEmptyIngredients) {
                isValid = false;
                errorMessage += 'Заполните все поля ингредиентов\n';
            }
            
            // Проверка шагов
            const steps = document.querySelectorAll('.step-description');
            let hasEmptySteps = false;
            steps.forEach(step => {
                if (!step.value.trim()) {
                    hasEmptySteps = true;
                    step.style.borderColor = '#f44336';
                } else {
                    step.style.borderColor = '';
                }
            });
            
            if (hasEmptySteps) {
                isValid = false;
                errorMessage += 'Заполните все шаги приготовления\n';
            }
            
            if (!isValid && !isPreview) {
                alert('Пожалуйста, исправьте следующие ошибки:\n\n' + errorMessage);
            }
            
            return isValid;
        }
        
        // Функция получения данных формы
        function getFormData() {
            const form = document.getElementById('recipeForm');
            
            // Собираем категории
            const categories = [];
            form.querySelectorAll('input[name="category"]:checked').forEach(checkbox => {
                categories.push(checkbox.value);
            });
            
            // Собираем ингредиенты
            const ingredients = [];
            document.querySelectorAll('.ingredient-row').forEach(row => {
                const name = row.querySelector('.ingredient-name').value;
                const amount = row.querySelector('.ingredient-amount').value;
                const unit = row.querySelector('.ingredient-unit').value;
                
                if (name.trim()) {
                    ingredients.push({
                        name: name,
                        amount: amount || 'по вкусу',
                        unit: unit
                    });
                }
            });
            
            // Собираем шаги
            const steps = [];
            document.querySelectorAll('.step-description').forEach(textarea => {
                if (textarea.value.trim()) {
                    steps.push(textarea.value);
                }
            });
            
            return {
                title: form.querySelector('#recipeTitle').value,
                description: form.querySelector('#recipeDescription').value,
                categories: categories,
                difficulty: form.querySelector('#difficulty').value,
                cookingTime: form.querySelector('#cookingTime').value,
                servings: form.querySelector('#servings').value || '4',
                ingredients: ingredients,
                steps: steps,
                tips: form.querySelector('#recipeTips').value,
                history: form.querySelector('#recipeHistory').value
            };
        }
        
        // Функция обработки отправки формы
        function handleSubmit(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                return;
            }
            
            const formData = getFormData();
            const user = window.db?.getCurrentUser?.();
            
            if (!user) {
                alert('Для добавления рецепта необходимо авторизоваться');
                window.location.href = 'auth.html?redirect=add-recipe.html';
                return;
            }
            
            // Создаем новый рецепт
            const newRecipe = {
                id: Date.now(),
                userId: user.id,
                title: formData.title,
                description: formData.description,
                categoryId: formData.categories[0] || '2', // Берем первую категорию
                cookingTime: parseInt(formData.cookingTime),
                difficulty: formData.difficulty,
                servings: parseInt(formData.servings),
                ingredients: formData.ingredients.map(ing => `${ing.name} - ${ing.amount} ${ing.unit}`),
                steps: formData.steps,
                tips: formData.tips || '',
                history: formData.history || '',
                rating: 0,
                favorites: 0,
                views: 0,
                createdAt: new Date().toISOString().split('T')[0]
            };
            
            // Добавляем рецепт в базу данных
            const addedRecipe = window.db?.addRecipe?.(newRecipe);
            
            if (addedRecipe) {
                alert(`Рецепт "${formData.title}" успешно добавлен!`);
                
                // Перенаправляем на страницу рецепта
                setTimeout(() => {
                    window.location.href = `recipe.html?id=${addedRecipe.id}`;
                }, 1000);
            } else {
                alert('Произошла ошибка при сохранении рецепта');
            }
        }
    </script>
</body>
</html>